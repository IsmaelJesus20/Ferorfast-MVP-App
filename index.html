<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReforFast - Prototipo PWA con IA</title>

    <!-- Metas PWA (simuladas para el prototipo) -->
    <meta name="theme-color" content="#a4cc3b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Dependencias CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Estilos y Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Paleta de colores y estilos base de la especificación */
        :root {
            --primary: #a4cc3b;   /* Verde principal */
            --secondary: #f59e0b;  /* Naranja alerta */
            --success: #10b981;   /* Verde confirmación */
            --warning: #f59e0b;   /* Amarillo precaución */
            --danger: #ef4444;    /* Rojo urgente */
            --gray: #6b7280;      /* Gris neutro */
            --light: #f9fafb;     /* Fondo claro */
            --dark: #111827;      /* Texto oscuro */
            --dark-card: #1f2937; /* Color para tarjetas en modo oscuro */
        }
        
        /* Estilos para Modo Oscuro */
        .dark {
            --light: #111827;
            --dark: #f9fafb;
            --gray: #9ca3af;
        }
        .dark .bg-white { background-color: var(--dark-card); }
        .dark .bg-light { background-color: #111827; }
        .dark .text-gray-700 { color: #d1d5db; }
        .dark .border { border-color: #374151; }
        .dark .border-gray-100 { border-color: #374151; }
        .dark .shadow-sm { box-shadow: 0 1px 2px 0 rgba(255, 255, 255, 0.05); }


        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            -webkit-tap-highlight-color: transparent; /* Mejora la experiencia táctil */
        }
        
        /* Clases de utilidad para colores */
        .bg-primary { background-color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .bg-success { background-color: var(--success); }
        .bg-danger { background-color: var(--danger); }
        .bg-warning { background-color: var(--warning); }
        .bg-dark-card { background-color: var(--dark-card); }
        .text-primary { color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-gray { color: var(--gray); }
        .border-primary { border-color: var(--primary); }
        .border-danger { border-color: var(--danger) !important; }


        /* Estilo para los botones principales (Touch-friendly) */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            min-height: 48px; /* Touch target size */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Un gris más claro */
            color: var(--dark);
        }
        .dark .btn-secondary {
            background-color: #374151;
            color: var(--dark);
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .screen {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Estilos para el interruptor */
        .toggle-checkbox:checked {
            transform: translateX(100%);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--primary);
        }
        #urgency-toggle:checked {
             border-color: var(--danger);
        }
        #urgency-toggle:checked + .toggle-label {
            background-color: var(--danger);
        }
        
        /* Notificación Toast */
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
            text-align: center;
        }
        .toast.show {
            bottom: 20px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Contenedor principal para las pantallas de la PWA -->
    <div id="app-container" class="max-w-md mx-auto bg-white shadow-lg md:rounded-lg">
        <!-- Las pantallas se inyectarán aquí dinámicamente -->
    </div>
    <div id="toast-notification" class="toast"></div>

    <!-- Scripts de la aplicación -->
    <script src="js/db.js"></script>
    <script src="js/sync.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.getElementById('app-container');
        const USER_PROFILE_KEY = 'reformfast_user_prototype';
        const DARK_MODE_KEY = 'reformfast_dark_mode';
        const APP_VERSION = '1.3.7'; // Versión actualizada
        let currentUser = null;

        // --- DATOS DE PRUEBA (MOCK DATA) ---
        let mockData = {
            projects: [
                { 
                    id: 'proj_1', 
                    name: 'Apartamento López', 
                    location: 'Baño', 
                    progress: 50, 
                    totalDays: 30, 
                    currentDay: 15,
                    changes: [
                        { id: 'chg_1a', description: 'Cambiar azulejos blancos por tipo metro.', status: 'Enviado', date: '2025-08-03', urgent: false },
                        { id: 'chg_1b', description: 'Añadir un punto de luz sobre el espejo.', status: 'Pendiente Sync', date: '2025-08-04', urgent: true }
                    ] 
                },
                { 
                    id: 'proj_2', 
                    name: 'Local Comercial Ruiz', 
                    location: 'Cocina', 
                    progress: 38, 
                    totalDays: 21, 
                    currentDay: 8,
                    changes: []
                },
                { 
                    id: 'proj_3', 
                    name: 'Chalet García', 
                    location: 'Jardín', 
                    progress: 80, 
                    totalDays: 45, 
                    currentDay: 36,
                    changes: [
                        { id: 'chg_3a', description: 'Instalar sistema de riego automático.', status: 'Enviado', date: '2025-07-28', urgent: false }
                    ]
                },
            ]
        };
        
        // --- PLANTILLAS DE PANTALLAS (HTML TEMPLATES) ---

        const LoginScreen = `
            <div id="login-screen" class="screen min-h-screen flex flex-col items-center justify-center p-6 bg-light">
                <div class="w-full max-w-sm text-center">
                    <img src="https://reforfast.eu/wp-content/uploads/2024/10/reforfast-1536x1054.png" alt="Logo de ReforFast" class="mx-auto h-20 w-auto mb-4">
                    <h1 class="text-4xl font-bold text-dark">ReforFast</h1>
                    <p class="text-gray mb-8">Gestión de Cambios en Obra</p>

                    <form id="login-form" class="space-y-4">
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray"></i>
                            <input type="text" id="username" placeholder="Nombre de Usuario" class="w-full p-4 pl-12 border rounded-lg text-lg focus:ring-2 focus:ring-primary focus:outline-none bg-white" required>
                        </div>
                        <div class="relative">
                             <i data-lucide="key-round" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray"></i>
                            <input type="password" id="access-code" placeholder="Código de Acceso" class="w-full p-4 pl-12 border rounded-lg text-lg focus:ring-2 focus:ring-primary focus:outline-none bg-white" required>
                        </div>
                        <button type="submit" class="w-full btn btn-primary text-lg">ENTRAR</button>
                    </form>
                    
                    <div id="login-error" class="text-danger mt-4 font-semibold h-6"></div>
                </div>
            </div>
        `;

        const DashboardScreen = () => `
            <div id="dashboard-screen" class="screen min-h-screen bg-light relative pb-24">
                <header class="sticky top-0 bg-white shadow-sm p-4 flex justify-between items-center z-10">
                    <div class="flex items-center gap-2">
                        <img src="https://reforfast.eu/wp-content/uploads/2024/10/reforfast-1536x1054.png" alt="Logo de ReforFast" class="h-8 w-auto">
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-semibold text-gray-700">${currentUser?.name || 'Usuario'}</span>
                        <button id="settings-button" class="p-1 rounded-full hover:bg-gray-100">
                            <i data-lucide="cog" class="text-gray h-6 w-6"></i>
                        </button>
                    </div>
                </header>
                
                <main class="p-4 space-y-6">
                    <h2 class="text-2xl font-bold text-dark">Mis Proyectos Activos</h2>
                    <div id="projects-list" class="space-y-4">
                        <!-- Los proyectos se insertarán aquí -->
                    </div>
                    <button id="new-quick-change" class="w-full btn btn-secondary mt-6 gap-2">
                        <i data-lucide="plus-circle"></i>
                        Nuevo Cambio Rápido
                    </button>
                </main>

                <div class="absolute bottom-4 right-4">
                     <button id="logout-button" class="flex items-center gap-2 bg-danger text-white py-2 px-4 rounded-full shadow-lg hover:opacity-90 transition-opacity">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                        <span>Salir</span>
                     </button>
                </div>
            </div>
        `;
        
        const CreateChangeScreen = (projectId) => {
            const project = mockData.projects.find(p => p.id === projectId) || mockData.projects[0];
            return `
            <div id="create-change-screen" class="screen min-h-screen bg-light">
                <header class="sticky top-0 bg-white shadow-sm p-4 flex items-center gap-4 z-10">
                    <button id="back-to-dashboard" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="h-6 w-6"></i></button>
                    <h1 class="font-bold text-xl text-dark">Nuevo Cambio</h1>
                </header>

                <main class="p-4 space-y-6">
                    <div>
                        <label for="project-select" class="font-semibold text-gray-700">PROYECTO</label>
                        <select id="project-select" class="w-full p-3 mt-1 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:outline-none">
                            ${mockData.projects.map(p => `<option value="${p.id}" ${p.id === project.id ? 'selected' : ''}>🏠 ${p.name}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label for="room-input" class="font-semibold text-gray-700">ESTANCIA</label>
                        <input type="text" id="room-input" placeholder="Ej: Baño principal" class="w-full p-3 mt-1 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:outline-none">
                    </div>

                    <div>
                        <label for="description-input" class="font-semibold text-gray-700">¿QUÉ QUIERE CAMBIAR?</label>
                        <textarea id="description-input" placeholder="Escribe o pulsa el botón para grabar..." rows="5" class="w-full p-3 mt-1 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:outline-none"></textarea>
                    </div>
                    
                    <button id="transcribe-btn" class="w-full btn bg-primary text-white gap-2">
                        <i data-lucide="mic"></i>
                        <span>Pulsar para Grabar Audio</span>
                    </button>
                    <p id="mic-status" class="text-center text-sm text-gray h-5"></p>

                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border">
                        <label for="urgency-toggle" class="font-bold text-lg text-dark flex items-center gap-2 cursor-pointer">
                            <i data-lucide="zap" class="text-danger"></i>
                            Urgente
                        </label>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="urgency-toggle" id="urgency-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="urgency-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    
                    <button id="send-change-btn" class="w-full btn btn-primary text-lg gap-2 mt-4">
                        <i data-lucide="send"></i>
                        ENVIAR CAMBIO
                    </button>
                </main>
            </div>
            `;
        }
        
        const SettingsScreen = () => `
            <div id="settings-screen" class="screen min-h-screen bg-light">
                <header class="sticky top-0 bg-white shadow-sm p-4 flex items-center gap-4 z-10">
                    <button id="back-to-dashboard" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="h-6 w-6"></i></button>
                    <h1 class="font-bold text-xl text-dark">Configuración</h1>
                </header>
                <main class="p-4 space-y-6">
                    <!-- Perfil Section -->
                    <div>
                        <h2 class="font-bold text-lg mb-2 text-dark">Perfil</h2>
                        <div class="bg-white p-4 rounded-lg border">
                            <p><strong>Usuario:</strong> ${currentUser?.name || 'No identificado'}</p>
                            <p class="text-sm text-gray mt-2">Versión de la App: ${APP_VERSION}</p>
                        </div>
                    </div>

                    <!-- Preferencias Section -->
                    <div>
                        <h2 class="font-bold text-lg mb-2 text-dark">Preferencias de la App</h2>
                        <div class="bg-white p-3 rounded-lg border space-y-3 divide-y divide-gray-100">
                             <div class="flex items-center justify-between pt-2">
                                <label for="sync-toggle" class="font-semibold text-gray-700 flex items-center gap-2 cursor-pointer">
                                    <i data-lucide="refresh-cw"></i>
                                    Sincronización automática
                                </label>
                                <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="sync-toggle" id="sync-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="sync-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div class="flex items-center justify-between pt-3">
                                <label for="dark-mode-toggle" class="font-semibold text-gray-700 flex items-center gap-2 cursor-pointer">
                                    <i data-lucide="moon"></i>
                                    Modo Oscuro
                                </label>
                                <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="dark-mode-toggle" id="dark-mode-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="dark-mode-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gestión de Datos Section -->
                    <div>
                         <h2 class="font-bold text-lg mb-2 text-dark">Gestión de Datos</h2>
                         <div class="space-y-2">
                            <button id="force-sync-btn" class="w-full btn btn-secondary gap-2"><i data-lucide="upload-cloud"></i>Forzar Sincronización</button>
                            <button id="clear-cache-btn" class="w-full btn bg-warning text-white gap-2"><i data-lucide="trash-2"></i>Limpiar Caché</button>
                         </div>
                    </div>
                    
                    <!-- Soporte Section -->
                    <div>
                         <h2 class="font-bold text-lg mb-2 text-dark">Soporte</h2>
                         <div class="space-y-2">
                             <a href="mailto:soporte@reformfast.com" class="w-full btn btn-secondary gap-2"><i data-lucide="mail"></i>Reportar un Problema</a>
                         </div>
                    </div>
                </main>
            </div>
        `;

        const ViewChangesScreen = (projectId) => {
            const project = mockData.projects.find(p => p.id === projectId);
            if (!project) return `<div class="p-4">Proyecto no encontrado</div>`;

            return `
            <div id="view-changes-screen" class="screen min-h-screen bg-light">
                <header class="sticky top-0 bg-white shadow-sm p-4 flex items-center gap-4 z-10">
                    <button id="back-to-dashboard" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="h-6 w-6"></i></button>
                    <div class="flex-1">
                        <h1 class="font-bold text-xl truncate text-dark">Cambios: ${project.name}</h1>
                    </div>
                </header>
                <main class="p-4 space-y-4">
                    ${
                        project.changes.length > 0
                        ? project.changes.map(change => `
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <p class="text-dark">${change.description}</p>
                                <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100 text-sm">
                                    <span class="text-gray">${new Date(change.date).toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}</span>
                                    <div class="flex items-center gap-2">
                                        ${change.urgent ? `<span class="inline-block px-2.5 py-1 text-xs font-semibold rounded-full bg-danger/10 text-danger dark:bg-danger/20">Urgente</span>` : ''}
                                        <span class="inline-block px-2.5 py-1 text-xs font-semibold rounded-full ${change.status === 'Enviado' ? 'bg-success/10 text-success dark:bg-success/20' : 'bg-warning/10 text-warning dark:bg-warning/20'}">
                                            ${change.status}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')
                        : `
                            <div class="text-center py-16">
                                 <i data-lucide="folder-check" class="h-20 w-20 mx-auto text-gray-300"></i>
                                 <h2 class="mt-4 text-lg font-semibold text-gray-700">Sin Cambios Registrados</h2>
                                 <p class="text-gray mt-1">Este proyecto no tiene cambios pendientes o enviados.</p>
                            </div>
                        `
                    }
                </main>
            </div>
            `;
        };


        // --- LÓGICA DE NAVEGACIÓN Y RENDERIZADO ---

        const navigateTo = (screenName, params = {}) => {
            let screenHtml = '';
            switch(screenName) {
                case 'login':
                    screenHtml = LoginScreen;
                    break;
                case 'dashboard':
                    screenHtml = DashboardScreen();
                    break;
                case 'createChange':
                    screenHtml = CreateChangeScreen(params.projectId);
                    break;
                case 'settings':
                    screenHtml = SettingsScreen();
                    break;
                case 'viewChanges':
                    screenHtml = ViewChangesScreen(params.projectId);
                    break;
                default:
                    screenHtml = `<div class="p-4">Pantalla no encontrada: ${screenName}</div>`;
            }
            
            appContainer.innerHTML = screenHtml;
            lucide.createIcons(); // Re-renderizar iconos
            attachEventListeners(screenName); // Añadir manejadores de eventos
        };
        
        window.navigateTo = navigateTo; // Hacerla global para acceso fácil

        const attachEventListeners = (screenName) => {
            switch(screenName) {
                case 'login':
                    initLoginScreen();
                    break;
                case 'dashboard':
                    initDashboardScreen();
                    break;
                case 'createChange':
                    initCreateChangeScreen();
                    break;
                case 'settings':
                    initSettingsScreen();
                    break;
                case 'viewChanges':
                    initViewChangesScreen();
                    break;
            }
        };

        // --- INICIALIZADORES DE PANTALLA ---

        function initLoginScreen() {
            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username');
            const accessCodeInput = document.getElementById('access-code');
            const errorDiv = document.getElementById('login-error');
            const submitButton = loginForm.querySelector('button[type="submit"]');

            // URL del webhook de n8n para el login. ¡DEBES REEMPLAZAR ESTA URL!
            const N8N_LOGIN_URL = 'https://mvpoh-n8n.ew1xnt.easypanel.host/webhook/97892bfa-be33-4a2d-aace-799da1a05b60';

            const lastUser = JSON.parse(localStorage.getItem(USER_PROFILE_KEY));
            if (lastUser) {
                usernameInput.value = lastUser.name;
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorDiv.textContent = '';
                submitButton.disabled = true;
                submitButton.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Entrando...';
                lucide.createIcons();

                const usuario = usernameInput.value.trim();
                const pin = accessCodeInput.value.trim();

                try {
                    const response = await fetch(N8N_LOGIN_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usuario, pin })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error de autenticación');
                    }

                    const { token, user } = await response.json();

                    // --- ¡ÉXITO! ---
                    if (!user || !user.full_name) {
                        console.error('Respuesta del webhook incompleta. Objeto USER:', user);
                        throw new Error('La respuesta del servidor no incluyó los datos del usuario.');
                    }

                    currentUser = { name: user.full_name, id: user.id, role: user.role || 'user' };
                    localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(currentUser));
                    localStorage.setItem('supabase_token', token);
                    
                    showToast(`¡Bienvenido, ${user.full_name}!`, 'success');
                    setTimeout(() => navigateTo('dashboard'), 500);

                } catch (error) {
                    errorDiv.textContent = error.message;
                    loginForm.classList.add('animate-shake');
                    setTimeout(() => loginForm.classList.remove('animate-shake'), 500);
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'ENTRAR';
                }
            });
        }
        
        function initDashboardScreen() {
            const projectsList = document.getElementById('projects-list');
            projectsList.innerHTML = mockData.projects.map(p => {
                const changeCount = p.changes.length;
                const statusText = changeCount > 0 ? `⚠️ ${changeCount} cambio${changeCount > 1 ? 's' : ''}` : '✅ Sin cambios';
                const statusClass = changeCount > 0 ? 'bg-warning/10 text-warning dark:bg-warning/20' : 'bg-success/10 text-success dark:bg-success/20';

                return `
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg text-dark">${p.name}</h3>
                        <span class="inline-block px-2.5 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    <p class="text-sm text-gray mt-1">📍 ${p.location} - día ${p.currentDay}/${p.totalDays}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                        <div class="bg-primary h-2.5 rounded-full" style="width: ${p.progress}%"></div>
                    </div>
                    <div class="flex gap-2 pt-4 mt-2 border-t border-gray-100">
                        <button data-project-id="${p.id}" class="btn btn-secondary text-sm flex-1 view-changes-btn">VER</button>
                        <button data-project-id="${p.id}" class="btn btn-primary text-sm flex-1 create-change-btn gap-1">
                            <i data-lucide="plus" class="h-4 w-4"></i> CAMBIO
                        </button>
                    </div>
                </div>
            `}).join('');

            lucide.createIcons();

            document.querySelectorAll('.create-change-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const projectId = e.currentTarget.dataset.projectId;
                    navigateTo('createChange', { projectId });
                });
            });
            
            document.querySelectorAll('.view-changes-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const projectId = e.currentTarget.dataset.projectId;
                    navigateTo('viewChanges', { projectId });
                });
            });

            document.getElementById('new-quick-change').addEventListener('click', () => {
                navigateTo('createChange', { projectId: mockData.projects[0].id });
            });
            
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem(USER_PROFILE_KEY);
                currentUser = null;
                navigateTo('login');
            });

            document.getElementById('settings-button').addEventListener('click', () => {
                navigateTo('settings');
            });
        }
        
        function initSettingsScreen() {
             document.getElementById('back-to-dashboard').addEventListener('click', () => {
                navigateTo('dashboard');
            });
            document.getElementById('force-sync-btn').addEventListener('click', () => {
                // Llamamos a la función de sincronización manual desde sync.js
                if (window.sync && typeof window.sync.syncPendingChanges === 'function') {
                    window.sync.syncPendingChanges();
                } else {
                    showToast('Error: La función de sincronización no está disponible.', 'error');
                }
            });
            document.getElementById('clear-cache-btn').addEventListener('click', () => {
                showToast('🗑️ Caché limpiada.', 'warning');
            });

            // Lógica del Modo Oscuro
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            darkModeToggle.checked = localStorage.getItem(DARK_MODE_KEY) === 'true';
            darkModeToggle.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.body.classList.add('dark');
                    localStorage.setItem(DARK_MODE_KEY, 'true');
                } else {
                    document.body.classList.remove('dark');
                    localStorage.setItem(DARK_MODE_KEY, 'false');
                }
            });
        }
        
        function initViewChangesScreen() {
            document.getElementById('back-to-dashboard').addEventListener('click', () => {
                navigateTo('dashboard');
            });
        }

        function initCreateChangeScreen() {
            document.getElementById('back-to-dashboard').addEventListener('click', () => {
                navigateTo('dashboard');
            });
            
            // --- Lógica de envío de cambio ---
            document.getElementById('send-change-btn').addEventListener('click', () => {
                const projectId = document.getElementById('project-select').value;
                const roomInput = document.getElementById('room-input');
                const descriptionInput = document.getElementById('description-input');
                const isUrgent = document.getElementById('urgency-toggle').checked;

                const room = roomInput.value.trim();
                const description = descriptionInput.value.trim();
                
                // --- VALIDACIÓN ---
                let errors = [];
                roomInput.classList.remove('border-danger');
                descriptionInput.classList.remove('border-danger');

                if (!room) {
                    errors.push('Estancia');
                    roomInput.classList.add('border-danger');
                }
                if (!description) {
                    errors.push('Descripción');
                    descriptionInput.classList.add('border-danger');
                }

                if (errors.length > 0) {
                    showToast(`Los campos obligatorios (${errors.join(', ')}) están vacíos.`, 'error');
                    return;
                }
                // --- FIN VALIDACIÓN ---

                const changePayload = {
                    user_id: currentUser.id,
                    project_id: projectId,
                    room: room,
                    description: description,
                    audio_url: null, // Placeholder for now
                    images_urls: [], // Placeholder for now
                    urgency: isUrgent ? 'alta' : 'baja',
                    source: 'app',
                    timestamp: new Date().toISOString()
                };

                // --- Lógica de envío con soporte OFFLINE ---
                if (navigator.onLine) {
                    sendChangeToServer(changePayload, projectId, room, description, isUrgent);
                } else {
                    window.db.saveChange(changePayload)
                        .then(() => {
                            showToast('🔌 Sin conexión. ¡Cambio guardado localmente!', 'warning');
                            updateUiWithPendingChange(projectId, room, description, isUrgent);
                            setTimeout(() => navigateTo('dashboard'), 1500);
                        })
                        .catch(err => {
                            console.error('Error al guardar el cambio en IndexedDB:', err);
                            showToast('Error al guardar el cambio localmente.', 'error');
                        });
                }
            });

            function sendChangeToServer(payload, projectId, room, description, isUrgent) {
                const n8nWebhookUrl = 'https://mvpoh-n8n.ew1xnt.easypanel.host/webhook/9bade41e-a73a-479e-92cd-1d9c0e7b4899';

                fetch(n8nWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ ¡Cambio enviado al sistema!', 'success');
                        updateUiWithPendingChange(projectId, room, description, isUrgent, 'Enviado');
                        setTimeout(() => navigateTo('dashboard'), 1500);
                    } else {
                        throw new Error(data.message || 'Error del servidor');
                    }
                })
                .catch(error => {
                    console.error('Error al enviar el cambio, guardando localmente:', error);
                    showToast('Error de red. Guardando para reintentar.', 'warning');
                    window.db.saveChange(payload);
                    updateUiWithPendingChange(projectId, room, description, isUrgent);
                    setTimeout(() => navigateTo('dashboard'), 1500);
                });
            }

            function updateUiWithPendingChange(projectId, room, description, isUrgent, status = 'Pendiente Sync') {
                const project = mockData.projects.find(p => p.id === projectId);
                if (project) {
                    project.changes.push({
                        id: `chg_${Date.now()}`,
                        description: `[${room}] ${description}`,
                        status: status,
                        date: new Date().toISOString().split('T')[0],
                        urgent: isUrgent
                    });
                }
            }

            // --- Lógica de transcripción de voz ---
            const transcribeBtn = document.getElementById('transcribe-btn');
            const descriptionInput = document.getElementById('description-input');
            const micStatus = document.getElementById('mic-status');

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                transcribeBtn.disabled = true;
                micStatus.textContent = 'Reconocimiento de voz no soportado.';
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.interimResults = true;
            recognition.continuous = true;

            let isRecording = false;

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                micStatus.textContent = interimTranscript;
                if (finalTranscript) {
                    descriptionInput.value += finalTranscript.trim() + '. ';
                }
            };

            recognition.onerror = (event) => {
                micStatus.textContent = `Error de micrófono: ${event.error}`;
                isRecording = false;
                updateButtonState();
            };

            recognition.onend = () => {
                if (isRecording) {
                    try { recognition.start(); } catch(e) { console.error(e); }
                } else {
                    updateButtonState();
                }
            };
            
            const updateButtonState = () => {
                if (isRecording) {
                    transcribeBtn.innerHTML = `<i data-lucide="mic-off"></i> <span>Detener Grabación</span>`;
                    transcribeBtn.classList.remove('bg-primary');
                    transcribeBtn.classList.add('bg-danger');
                    micStatus.textContent = 'Escuchando...';
                } else {
                    transcribeBtn.innerHTML = `<i data-lucide="mic"></i> <span>Pulsar para Grabar Audio</span>`;
                    transcribeBtn.classList.remove('bg-danger');
                    transcribeBtn.classList.add('bg-primary');
                    micStatus.textContent = '';
                }
                lucide.createIcons();
            };

            transcribeBtn.addEventListener('click', () => {
                isRecording = !isRecording;
                if (isRecording) {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.error("Error starting recognition:", e);
                        micStatus.textContent = 'No se pudo iniciar la grabación.';
                        isRecording = false;
                    }
                } else {
                    recognition.stop();
                }
                updateButtonState();
            });
        }
        
        // --- Función para mostrar notificaciones ---
        // La hacemos global para poder usarla desde sync.js
        window.showToast = function(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-dark-card');
            
            switch (type) {
                case 'error':
                    toast.classList.add('bg-danger');
                    break;
                case 'warning':
                    toast.classList.add('bg-warning');
                    break;
                case 'success':
                    toast.classList.add('bg-success');
                    break;
                case 'info':
                default:
                    toast.classList.add('bg-dark-card');
            }

            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- INICIO DE LA APLICACIÓN ---
        const initApp = () => {
            // Aplicar modo oscuro al inicio si está guardado
            if (localStorage.getItem(DARK_MODE_KEY) === 'true') {
                document.body.classList.add('dark');
            }

            const storedUser = localStorage.getItem(USER_PROFILE_KEY);
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                navigateTo('dashboard');
            } else {
                navigateTo('login');
            }
        };

        initApp();
    });
    </script>
</body>
</html>